---
// Page loader component - shows only if page takes longer than expected to load
// Uses loader--6 (circles through circles animation)
---

<div id="page-loader" class="page-loader">
	<i class="loader loader--6"></i>
</div>

<style>
	.page-loader {
		--block-size: 18vmin;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: linear-gradient(to right top, #F27121, #E94057, #8A2387);
		display: grid;
		place-items: center;
		z-index: 9999;
		opacity: 0;
		pointer-events: none;
		transition: opacity 0.3s ease;
	}

	.page-loader.visible {
		opacity: 1;
		pointer-events: auto;
	}

	.page-loader.fade-out {
		opacity: 0;
		pointer-events: none;
	}

	/* Loader styles */
	.loader {
		--loader-size: calc(var(--block-size) / 3);
		--loader-size-half: calc(var(--loader-size) / 2);
		--loader-size-half-neg: calc(var(--loader-size-half) * -1);
		--light-color: rgba(255, 255, 255, 0.3);
		--dot-size: 5px;
		--dot-size-half: calc(var(--dot-size) / 2);
		--dot-size-half-neg: calc(var(--dot-size-half) * -1);
		
		display: block;
		position: relative;
		width: var(--loader-size);
		display: grid;
		place-items: center;
		color: white;
	}

	.loader::before,
	.loader::after {
		content: '';
		position: absolute;
	}

	/* loader--6 */
	.loader--6 {
		--loader-size: calc(var(--block-size) / 3);
		--anim-duration: 0.6s;
		aspect-ratio: 1 / 1;
		perspective: 50vmin;
		transform-style: preserve-3d;
		transform: rotateX(35deg);
	}

	.loader--6::before,
	.loader--6::after {
		width: 50%;
		aspect-ratio: 1 / 1;
		background-color: currentColor;
		top: 25%;
		left: 25%;
		animation: loader-6 var(--anim-duration) cubic-bezier(0.07, 0.59, 0.56, 0.88) infinite;
	}

	.loader--6::before {
		--turn-deg: -60deg;
		--x-dist: -25%;
		transform-origin: left calc(var(--loader-size) * -1);
	}

	.loader--6::after {
		--turn-deg: 60deg;
		--x-dist: 25%;
		transform-origin: right calc(var(--loader-size) * -1);
		animation-delay: calc(var(--anim-duration) / 2 * -1);
	}

	@keyframes loader-6 {
		0% {
			transform: scale(0.3) translateZ(-15vmin) rotateY(calc(var(--turn-deg) * -1));
		}
		
		0%, 100% {
			opacity: 0;
		}
		
		33% {
			opacity: 0.8;
			transform: scale(1.2) translateZ(5vmin) translateX(var(--x-dist));
		}
		
		100% {
			transform: scale(1.2) translateZ(5vmin) translateX(var(--x-dist)) rotateY(var(--turn-deg));
		}
	}
</style>

<script>
	// Show loader only if page takes longer than 3 seconds to fully load
	// Most modern pages load in < 1.5 seconds, so this is conservative
	const LOADER_THRESHOLD = 3000; // 3 seconds
	let loaderTimeout: ReturnType<typeof setTimeout>;
	let pageLoaded = false;

	const loaderEl = document.getElementById('page-loader');

	if (loaderEl) {
		// Set timeout to show loader if page is still loading
		loaderTimeout = setTimeout(() => {
			if (!pageLoaded && loaderEl) {
				loaderEl.classList.add('visible');
			}
		}, LOADER_THRESHOLD);

		// Hide loader when page is fully loaded
		const hideLoader = () => {
			pageLoaded = true;
			clearTimeout(loaderTimeout);
			
			if (loaderEl) {
				loaderEl.classList.remove('visible');
				loaderEl.classList.add('fade-out');
				
				// Remove from DOM after fade completes
				setTimeout(() => {
					loaderEl?.remove();
				}, 300);
			}
		};

		// Listen for page load events
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', hideLoader);
			window.addEventListener('load', hideLoader);
		} else {
			// Page already loaded (for client-side navigation in Astro)
			hideLoader();
		}

		// Also hide on navigation start (for Astro View Transitions)
		document.addEventListener('astro:before-preparation', () => {
			if (!pageLoaded) {
				pageLoaded = false;
				loaderTimeout = setTimeout(() => {
					if (!pageLoaded && loaderEl && !loaderEl.classList.contains('visible')) {
						loaderEl.classList.add('visible');
					}
				}, LOADER_THRESHOLD);
			}
		});

		document.addEventListener('astro:after-swap', hideLoader);
	}
</script>
